<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahindra : Explore Tractor 360 Experience</title>
    <style>
        /* Global styling for the body */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* Loader Styles */
        #loader, #popupLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Specific style for popup loader */
        #popupLoader {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 155; /* Ensure it's above popup content but below close button */
        }


        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-left-color: #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        #loadingProgress {
            margin-top: 20px;
            font-size: 1.2rem;
            color: #fff;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }


        /* Canvas styling - it is initially hidden */
        canvas {
            display: none; /* Initially hidden */
            width: 100%;
            height: 100vh;
        }

        /* Landing Page Styling */
        #landingPage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* Align items to the bottom */
            align-items: center;
            /* background: url("https://mahindra.inceptionx.io/res/landing/landing.jpeg") no-repeat center bottom; */ /* MODIFIED: Set via JS */
            background-size: cover;
            background-position: center bottom;
            background-repeat: no-repeat;
            text-align: center;
            z-index: 100;
            transition: opacity 1s ease-in-out; /* Smooth transition */
            opacity: 1;
            padding-bottom: 5vh; /* Adjusted padding from the bottom */
            box-sizing: border-box; /* Include padding within the element's total height */
        }

        #landingPage.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }

        #landingPage h1 {
            font-size: 3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin-bottom: 0.5rem;
        }

        #landingPage p {
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin-bottom: 2rem;
        }

        #startButton {
            /* background: url("https://mahindra.inceptionx.io/res/ui/enter.png") no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            border: none;
            width: 200px; /* Adjust size as needed */
            height: 50px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            background-color: transparent;
        }

        #startButton:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        #startButton:active {
            transform: scale(0.98);
        }

        /* Video Overlay Styles */
        #videoOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Above everything else */
        }
        #videoContainer {
            position: relative;
            width: 80%; /* Adjust as needed */
            max-width: 800px; /* Max width for video */
            background-color: #000;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); /* Green glow */
            padding-bottom: 45%;
            height: 0;
        }
        #videoPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
        }
        #closeVideoBtn {
            position: absolute;
            top: -45px; /* Position it above the video container */
            right: 0px;
            /* background: url('https://mahindra.inceptionx.io/res/ui/close.png') no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 210; /* Ensure it's above the video container */
            transition: transform 0.2s ease;
        }
        #closeVideoBtn:hover {
            transform: scale(1.1);
        }

        /* Hotspot icon styling */
        .hotspot-icon {
            background-color: rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
            transition: transform 0.2s ease;
        }
        .hotspot-icon:hover {
            transform: scale(1.2);
        }

        /* Instruction Popup Styles */
        #instructionPopupOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 250;
        }

        #instructionPopupContent {
            position: relative;
            width: 80vw; /* Use up to 80% of the viewport width */
            max-width: 600px; /* But no more than 600px */
            aspect-ratio: 1895 / 884; /* Maintain a 2:1 aspect ratio, matching the image */
            /* background: url('https://mahindra.inceptionx.io/res/ui/instructions.png') no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: cover; /* The image will cover the entire area without distortion */
            background-position: center center;
            background-repeat: no-repeat;
        }

        #closeInstructionBtn {
            position: absolute;
            top: 13px; /* Position inside the top edge */
            right: 20px; /* Position inside the right edge */
            /* background: url('https://mahindra.inceptionx.io/res/ui/close.png') no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 260;
            transition: transform 0.2s ease;
        }
        #closeInstructionBtn:hover {
            transform: scale(1.1);
        }

        /* MODIFIED: Styles for the options popup */
        #optionsPopup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center; /* Center the content vertically and horizontally */
            z-index: 150;
        }
        
        #popupContent {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            cursor: grab;
        }
        
        #popupContent.dragging {
            cursor: grabbing;
        }

        #popupVideo {
           display: none;
        }
        
        /* MODIFIED: Wrapper for canvas and hotspots to maintain aspect ratio */
        #canvasWrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* width and height are controlled by JavaScript to create a "cover" effect */
        }
        
        /* MODIFIED: Canvas fills the new wrapper */
        #popupCanvas {
            width: 100%;
            height: 100%;
            user-select: none;
            display: block; /* Removes any default bottom margin/space */
        }


        #closePopupBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            /* background: url('https://mahindra.inceptionx.io/res/ui/close.png') no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            border: none;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 160;
            transition: transform 0.2s ease;
        }
        #closePopupBtn:hover {
            transform: scale(1.1);
        }

        /* MODIFIED: Hotspot container is now inside the canvas wrapper */
        #hotspot2DContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .hotspot-2d {
            position: absolute;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: transform 0.2s ease;
            pointer-events: auto;
            transform: translate(-50%, -50%);
        }
        .hotspot-2d img, .hotspot-2d video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }
        .hotspot-2d:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        /* Static 360 Icon */
        #static360Icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            z-index: 172;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
            overflow: hidden;
        }

        #static360Icon video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Styles for the text info box */
        #textInfoBox {
            position: absolute;
            top: 20%;
            left: 20%;
            width: 250px;
            aspect-ratio: 735 / 463;
            /* background: url('https://mahindra.inceptionx.io/res/ui/info_box.png') no-repeat center center; */ /* MODIFIED: Set via JS */
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            color: rgb(0, 0, 0);
            padding: 40px;
            z-index: 170;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
            box-sizing: border-box;
            overflow-y: hidden;
        }

        #textInfoBox p {
            margin: 0;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-weight: 600;
            font-size: 20px;
            line-height: 1.4;
            white-space: pre-line;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #popupControls {
            display: none; 
        }
        
        .option-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 250px;
            height: 8px;
            background: #555;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 5px;
            margin: 0 15px;
        }

        .option-slider:hover {
            opacity: 1;
        }

        .option-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #333;
        }

        .option-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #fff;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #333;
        }


        /* Styles for the new vertical toolbar */
        #verticalToolbar {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 40px; /* Adjusted spacing for smaller buttons */
            z-index: 171; /* Set to be on top of the options popup */
            background-color: white; /* Set background to white */
            padding: 15px; /* Added more padding */
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); /* Added a subtle shadow */
        }

        .toolbar-btn {
            background-color: transparent;
            border: none;
            width: 30px; /* Made buttons smaller */
            height: 30px; /* Made buttons smaller */
            cursor: pointer;
            transition: transform 0.2s ease;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain; /* Use contain to fit the whole image */
        }

        .toolbar-btn:hover {
            transform: scale(1.1);
        }

    </style>
</head>
<body>
    <!-- NEW: Loader element -->
    <div id="loader">
        <div class="spinner"></div>
        <div id="loadingProgress">Loading 0%</div>
    </div>

    <div id="landingPage">
        <button id="startButton"></button>
    </div>

    <div id="instructionPopupOverlay">
        <div id="instructionPopupContent">
            <button id="closeInstructionBtn"></button>
        </div>
    </div>
    
    <div id="verticalToolbar">
        <button id="fullscreenBtn" class="toolbar-btn"></button>
        <button id="zoomIn360Btn" class="toolbar-btn"></button>
        <button id="zoomOut360Btn" class="toolbar-btn"></button>
        <button id="soundBtn" class="toolbar-btn"></button>
    </div>


    <div id="optionsPopup">
        <!-- NEW: Loader for the options popup -->
        <div id="popupLoader" style="display: none;">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Preparing Experience...</p>
        </div>

        <div id="popupContent">
            <!-- NEW: Wrapper for canvas and hotspots to maintain aspect ratio -->
            <div id="canvasWrapper">
                <!-- Canvas for video frames -->
                <canvas id="popupCanvas"></canvas>
                <!-- Container for 2D hotspots -->
                <div id="hotspot2DContainer"></div>
            </div>
            
            <!-- The video element is now hidden and used as a data source for the canvas -->
            <video id="popupVideo" muted playsinline crossorigin="anonymous"></video>
            
            <div id="textInfoBox">
                <p id="textInfoContent"></p>
            </div>
            
            <button id="closePopupBtn"></button>

            <!-- The slider is now hidden and controlled by dragging -->
            <div id="popupControls">
                <input type="range" id="optionSlider" class="option-slider" value="0" min="0" max="100">
            </div>
        </div>
    </div>

    <div id="videoOverlay">
        <div id="videoContainer">
            <iframe id="videoPlayer" width="100%" height="100%" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            <button id="closeVideoBtn"></button>
        </div>
    </div>
    
    <div id="static360Icon">
        <video autoplay loop muted playsinline crossorigin="anonymous"></video>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // Declare global variables for the Three.js scene
        let scene, camera, renderer;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let sphere, material;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let hotspotMeshes = [];
        let activeHotspotVideo = null; // To track the currently playing hotspot video
        
        // New video texture for 3D hotspots
        let hotspotVideoTexture = null;
        
        // Variables for popup content dragging (for panning when zoomed)
        let isPopupDragging = false;
        let startPopupDragX = 0;
        let startPopupDragY = 0;
        // NEW: Variable to store video time at the start of a drag
        let startVideoTimeOnDrag = 0;

        // Variables for zooming and panning
        let zoomLevel = 1;
        let maxZoom = 3;
        let minZoom = 1;
        let panX = 0;
        let panY = 0;
        let startPanX = 0;
        let startPanY = 0;

        // New variable for sound state
        let isSoundOn = false;
        let bonnetSound = null; // To hold the looping sound element

        // New timer for the auto-hiding text info box
        let textInfoTimer = null;
        
        // NEW: Variable to track the current state of the tractor animation (e.g., 'bonnetClosed')
        let currentVideoState = 'bonnetClosed';
        
        // NEW: Variables for canvas rendering
        let popupCanvas, ctx;
        let transitionAnimationId = null;

        // *** FIX: Flag to prevent dragging before video metadata is loaded ***
        let isVideoReadyForScrub = false;

        // *** OPTIMIZATION: Variables for hotspot management ***
        let allHotspotElements = [];
        let hotspotsInitialized = false;

        // *** MODIFIED: Asset cache to store preloaded elements ***
        const assetCache = {};


        // HTML elements
        const loader = document.getElementById('loader');
        const loadingProgress = document.getElementById('loadingProgress');
        const landingPage = document.getElementById('landingPage');
        const startButton = document.getElementById('startButton');
        const videoOverlay = document.getElementById('videoOverlay');
        const videoPlayer = document.getElementById('videoPlayer');
        const closeVideoBtn = document.getElementById('closeVideoBtn');
        const optionsPopup = document.getElementById('optionsPopup');
        const popupLoader = document.getElementById('popupLoader'); // New popup loader element
        const popupContent = document.getElementById('popupContent');
        const popupVideo = document.getElementById('popupVideo');
        const closePopupBtn = document.getElementById('closePopupBtn');
        const hotspot2DContainer = document.getElementById('hotspot2DContainer');
        const textInfoBox = document.getElementById('textInfoBox');
        const textInfoContent = document.getElementById('textInfoContent');
        const instructionPopupOverlay = document.getElementById('instructionPopupOverlay');
        const instructionPopupContent = document.getElementById('instructionPopupContent');
        const closeInstructionBtn = document.getElementById('closeInstructionBtn');
        const static360Icon = document.getElementById('static360Icon');
        const optionSlider = document.getElementById('optionSlider'); // Keep reference, though hidden
        
        // New Toolbar Elements
        const verticalToolbar = document.getElementById('verticalToolbar');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const zoomIn360Btn = document.getElementById('zoomIn360Btn');
        const zoomOut360Btn = document.getElementById('zoomOut360Btn');
        const soundBtn = document.getElementById('soundBtn');


        // Direct URLs for panoramic images and assets
        const panorama1ImageUrl = "https://mahindra.inceptionx.io/res/nav/1.png";
        const panorama2ImageUrl = "https://mahindra.inceptionx.io/res/nav/2.png";
        const panorama3ImageUrl = "https://mahindra.inceptionx.io/res/nav/3.png";

        // Data structure for panoramic images and their hotspots
        const panoData = [
            { name: "Panorama 1", imageUrl: panorama1ImageUrl, hotspots: [{ id: "nextPanoArrow1", position: new THREE.Vector3(80, -20, 0), rotation: new THREE.Vector3(0, Math.PI / 2, 0), type: "arrow", targetPanoIndex: 1, label: "Next" }] },
            { name: "Panorama 2", imageUrl: panorama2ImageUrl, hotspots: [{ id: "nextPanoArrow2", position: new THREE.Vector3(80, -20, 0), rotation: new THREE.Vector3(0, Math.PI / 2, 0), type: "arrow", targetPanoIndex: 2, label: "Next" }, { id: "backPanoArrow2", position: new THREE.Vector3(-80, -20, 0), rotation: new THREE.Vector3(0, -Math.PI / 2, 0), type: "arrow", targetPanoIndex: 0, label: "Back" }] },
            { name: "Panorama 3", imageUrl: panorama3ImageUrl, hotspots: [{ id: "popupHotspot3D", position: new THREE.Vector3(80, -25,0), type: "popup", label: "Explore Tractor" }, { id: "backPanoArrow", position: new THREE.Vector3(-80, -20, 0), rotation: new THREE.Vector3(0, -Math.PI / 2, 0), type: "arrow", targetPanoIndex: 1, label: "Back" }] }
        ];

        // NEW: Centralized hotspot configuration for the single tractor_animation.webm video.
        // This structure defines different "states" of the video, each with its own scrubbable time range and hotspots.
        const hotspotConfigurations = {
            states: {
                'bonnetClosed': {
                    scrubRange: [0, 3.367], // Time range in seconds for this state
                    options: [ // Hotspots are defined based on the video's absolute current time
                        { 
                            range: [0, 0.3], 
                            hotspots: [
                                { x: 40, y: 72, label: "A", type: "text_info", text:"Turning Radius\n2.3 Mtrs" },
                                { x: 52, y: 52, label: "B", type: "text_info", text: "Battery\n88 Amp x 12 volt" },
                                { x: 43, y: 45, label: "C", type: "text_info", text: "Headlamps\nTrapezoidal Clear\nLense" }
                            ] 
                        },
                        { 
                            range: [0.75, 0.85], 
                            hotspots: [
                                {
                                  x: 66, y: 42, label: "A", type: "transition", 
                                  soundUrl: "https://mahindra.inceptionx.io/res/ui/bonnet_clip.mp3",
                                  transitionRange: [3.367, 6.733], // Time range of the open-bonnet animation
                                  nextState: 'bonnetOpen', // State to switch to after animation
                                  nextStateStartTime: 6.5 // <<< MODIFIED: Specific start time for the next state
                                },
                                { x: 69, y: 58, label: "C", type: "text_info", text: "Front Tyre Size\n7.15 x 16" },
                                { x: 47, y: 58, label: "D", type: "text_info", text: "PCM\nTransmission" },
                                { x: 34, y: 50, label: "E", type: "text_info", text: "Rear Tyre Size\n14.9 x 28" },
                            ] 
                        },
                        { 
                            range: [1.1, 1.21], 
                            hotspots: [
                                { x: 57.5, y: 36, label: "A", type: "text_info", text:"Wet Type\nAir Filter" },
                                { x: 54, y: 56, label: "B", type: "text_info", text: "Dual\nClutch" },
                                { x: 68, y: 65, label: "C", type: "text_info", text: "Oil\nImmersed\nBrakes" }
                            ] 
                        },
                        { 
                            range: [1.65, 1.75], 
                            hotspots: [
                                { x: 55, y: 45, label: "A", type: "text_info", text:"Engine CC\n2979" },
                                { x: 54, y: 64, label: "B", type: "text_info", text: "PTO HP\n44.9" },
                                { x: 49, y: 55, label: "C", type: "text_info", text: "Hydraulic\nLift Capacity\n2000 Kg" }
                            ] 
                        },
                        { 
                            range: [3.1, 3.3], 
                            hotspots: [
                                { x: 40, y: 72, label: "A", type: "text_info", text:"Turning Radius\n2.3 Mtrs" },
                                { x: 52, y: 52, label: "B", type: "text_info", text: "Battery\n88 Amp x 12 volt" },
                                { x: 43, y: 45, label: "C", type: "text_info", text: "Headlamps\nTrapezoidal Clear\nLense" }
                            ] 
                        }
                    ]
                },
                'bonnetOpen': {
                    scrubRange: [6.733, 10.767], // Time range for when the bonnet is open
                    options: [
                        { 
                            range: [6.5, 7.5], 
                            hotspots: [
                                {
                                  x: 66, y: 42, label: "A", type: "transition",
                                  transitionRange: [10.767,  14.1], // Time range of the close-bonnet animation
                                  nextState: 'bonnetClosed', // State to switch to after animation
                                  nextStateStartTime: 0.75 // <<< MODIFIED: Specific start time for the next state
                                },
                                { x: 69, y: 58, label: "C", type: "text_info", text: "Front Tyre Size\n7.15 x 16" },
                                { x: 47, y: 58, label: "D", type: "text_info", text: "PCM\nTransmission" },
                                { x: 34, y: 50, label: "E", type: "text_info", text: "Rear Tyre Size\n14.9 x 28" },
                            ] 
                        },
                        { 
                            range: [7.6, 7.8], 
                            hotspots: [
                                { x: 57.5, y: 36, label: "A", type: "text_info", text:"Wet Type\nAir Filter" },
                                { x: 54, y: 56, label: "B", type: "text_info", text: "Dual\nClutch" },
                                { x: 68, y: 65, label: "C", type: "text_info", text: "Oil\nImmersed\nBrakes" }
                            ] 
                        },
                        { 
                            range: [8.4, 8.5], 
                            hotspots: [
                                { x: 55, y: 45, label: "A", type: "text_info", text:"Engine CC\n2979" },
                                { x: 54, y: 64, label: "B", type: "text_info", text: "PTO HP\n44.9" },
                                { x: 49, y: 55, label: "C", type: "text_info", text: "Hydraulic\nLift Capacity\n2000 Kg" }
                            ] 
                        },
                        { 
                            range: [9.9, 10], 
                            hotspots: [
                                { x: 40, y: 72, label: "A", type: "text_info", text:"Turning Radius\n2.3 Mtrs" },
                                { x: 52, y: 52, label: "B", type: "text_info", text: "Battery\n88 Amp x 12 volt" },
                                { x: 43, y: 45, label: "C", type: "text_info", text: "Headlamps\nTrapezoidal Clear\nLense" }
                            ] 
                        }
                    ]
                }
            }
        };

        // NEW: Array of all assets to preload
        const assetsToLoad = [
            // Landing
            'https://mahindra.inceptionx.io/res/landing/landing.jpeg',
            'https://mahindra.inceptionx.io/res/ui/enter.png',
            // UI
            'https://mahindra.inceptionx.io/res/ui/close.png',
            'https://mahindra.inceptionx.io/res/ui/instructions.png',
            'https://mahindra.inceptionx.io/res/ui/360.webm',
            'https://mahindra.inceptionx.io/res/ui/info_box.png',
            'https://mahindra.inceptionx.io/res/ui/full_screen.png',
            'https://mahindra.inceptionx.io/res/ui/zoom_in.png',
            'https://mahindra.inceptionx.io/res/ui/zoom_out.png',
            'https://mahindra.inceptionx.io/res/ui/vol_on.png',
            'https://mahindra.inceptionx.io/res/ui/vol_off.png',
            'https://mahindra.inceptionx.io/res/ui/nav_arrow.webm',
            'https://mahindra.inceptionx.io/res/ui/explore_tractor.webm',
            'https://mahindra.inceptionx.io/res/ui/hotspot_bonnet.png',
            'https://mahindra.inceptionx.io/res/ui/hotspot_normal.png',
            'https://mahindra.inceptionx.io/res/ui/hotspot.webm',
            'https://mahindra.inceptionx.io/res/ui/hotspot_optionspopup.webm',
            // Panoramas
            panorama1ImageUrl,
            panorama2ImageUrl,
            panorama3ImageUrl,
            // 3D Video (Single merged file)
            'https://mahindra.inceptionx.io/res/3D/tractor_animation.webm',
            // Sounds
            'https://mahindra.inceptionx.io/res/ui/bonnet_clip.mp3'
        ];

        
        /**
         * *** MODIFIED: Preloads assets by fetching them as blobs and creating blob URLs. ***
         */
        async function preloadAssets() {
            let loadedCount = 0;
            const totalAssets = assetsToLoad.length;
            
            if (totalAssets === 0) {
                onLoadingComplete();
                return;
            }

            const promises = assetsToLoad.map(async (url) => {
                try {
                    // Using a proxy to bypass potential CORS issues in some environments
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const blob = await response.blob();
                    assetCache[url] = URL.createObjectURL(blob);
                } catch (error) {
                    console.error(`Failed to load asset: ${url}`, error);
                    assetCache[url] = url; // Fallback to direct URL on error
                } finally {
                    loadedCount++;
                    const progress = Math.round((loadedCount / totalAssets) * 100);
                    loadingProgress.textContent = `Loading ${progress}%`;
                }
            });

            await Promise.all(promises);
            onLoadingComplete();
        }
        
        /**
         * *** NEW: Applies cached assets (as blob URLs) to elements after loading. ***
         */
        function applyCachedAssets() {
            // Landing Page
            landingPage.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/landing/landing.jpeg']})`;
            startButton.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/enter.png']})`;
            
            // UI Buttons
            const closeBtnUrl = assetCache['https://mahindra.inceptionx.io/res/ui/close.png'];
            closeVideoBtn.style.backgroundImage = `url(${closeBtnUrl})`;
            closeInstructionBtn.style.backgroundImage = `url(${closeBtnUrl})`;
            closePopupBtn.style.backgroundImage = `url(${closeBtnUrl})`;

            // Instruction Popup
            instructionPopupContent.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/instructions.png']})`;

            // Info Box
            textInfoBox.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/info_box.png']})`;
            
            // Toolbar Buttons
            fullscreenBtn.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/full_screen.png']})`;
            zoomIn360Btn.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/zoom_in.png']})`;
            zoomOut360Btn.style.backgroundImage = `url(${assetCache['https://mahindra.inceptionx.io/res/ui/zoom_out.png']})`;
            
            // Sound button is handled separately
            updateSoundButton();
        }
        
        /**
         * MODIFIED: Called when all assets are preloaded.
         */
        function onLoadingComplete() {
            applyCachedAssets(); // Apply all cached images to their elements
            
            // Hide loader with a fade-out effect
            loader.style.transition = 'opacity 0.5s ease';
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                landingPage.style.display = 'flex'; // Show landing page
            }, 500);
        }


        /**
         * Handles mouse wheel events for zooming.
         */
        function onMouseWheel(event) {
            event.preventDefault();
            const zoomSpeed = 1.5;
            camera.fov += event.deltaY * 0.05 * zoomSpeed;
            camera.fov = Math.max(10, Math.min(60, camera.fov));
            camera.updateProjectionMatrix();
        }

        /**
         * Handles the mouse down event to start dragging.
         */
        function onMouseDown(event) {
            isDragging = true;
            previousMousePosition.x = event.clientX;
            previousMousePosition.y = event.clientY;
        }

        /**
         * Handles the mouse up event to stop dragging.
         */
        function onMouseUp(event) {
            isDragging = false;
        }

        /**
         * Handles the mouse move event to rotate the camera when dragging.
         */
        function onMouseMove(event) {
            if (!isDragging) return;
            const deltaX = event.clientX - previousMousePosition.x;
            const horizontalRotationSpeed = 0.005;
            camera.rotation.y -= deltaX * horizontalRotationSpeed;
            camera.rotation.x = 0;
            camera.rotation.z = 0;
            previousMousePosition.x = event.clientX;
            previousMousePosition.y = event.clientY;
        }

        /**
         * Handles clicks on the canvas for hotspot interaction.
         */
        function onCanvasClick(event) {
            if (optionsPopup.style.display === 'flex' || videoOverlay.style.display === 'flex') return;
            mouse.x = (event.clientX / renderer.domElement.clientWidth) * 2 - 1;
            mouse.y = - (event.clientY / renderer.domElement.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(hotspotMeshes, true);
            if (intersects.length > 0) {
                let clickedHotspot = intersects[0].object;
                while (clickedHotspot.parent && hotspotMeshes.indexOf(clickedHotspot) === -1) {
                    clickedHotspot = clickedHotspot.parent;
                }
                const hotspotData = clickedHotspot.userData;
                if (hotspotData && hotspotData.type === "arrow" && hotspotData.targetPanoIndex !== undefined) {
                    loadPanoramicImage(panoData[hotspotData.targetPanoIndex].imageUrl, hotspotData.targetPanoIndex);
                } else if (hotspotData && hotspotData.type === "video" && hotspotData.videoUrl) {
                    showVideo(hotspotData.videoUrl);
                } else if (hotspotData && hotspotData.type === "popup") {
                    showOptionsPopup();
                }
            }
        }

        /**
         * Handles the touch start event.
         */
        function onTouchStart(event) {
            if (optionsPopup.style.display === 'flex' || videoOverlay.style.display === 'flex') return;
            if (event.touches.length === 1) {
                isDragging = true;
                previousMousePosition.x = event.touches[0].clientX;
                previousMousePosition.y = event.touches[0].clientY;
            }
        }

        /**
         * Handles the touch end event.
         */
        function onTouchEnd(event) {
            if (optionsPopup.style.display === 'flex' || videoOverlay.style.display === 'flex') return;
            isDragging = false;
            if (event.changedTouches.length > 0) {
                onCanvasClick({ clientX: event.changedTouches[0].clientX, clientY: event.changedTouches[0].clientY });
            }
        }

        /**
         * Handles the touch move event.
         */
        function onTouchMove(event) {
            if (optionsPopup.style.display === 'flex' || videoOverlay.style.display === 'flex') return;
            if (!isDragging || event.touches.length !== 1) return;
            const deltaX = event.touches[0].clientX - previousMousePosition.x;
            const horizontalRotationSpeed = 0.0025;
            camera.rotation.y -= deltaX * horizontalRotationSpeed;
            camera.rotation.x = 0;
            camera.rotation.z = 0;
            previousMousePosition.x = event.touches[0].clientX;
            previousMousePosition.y = event.clientY;
            event.preventDefault();
        }
        
        /**
         * MODIFIED: Handles mouse down for both panning (when zoomed) and video scrubbing.
         */
        function onPopupMouseDown(event) {
            // *** FIX: Guard against dragging before video is ready ***
            if (!isVideoReadyForScrub || event.target.closest('.hotspot-2d')) return;
            
            isPopupDragging = true;
            startPopupDragX = event.clientX;
            startPopupDragY = event.clientY;
            popupContent.classList.add('dragging');

            if (zoomLevel > 1) {
                // Logic for panning when zoomed in
                startPanX = panX;
                startPanY = panY;
            } else {
                // Logic for scrubbing video when not zoomed
                startVideoTimeOnDrag = popupVideo.currentTime;
            }
        }


        /**
         * Handles the mouse up event for the popup video.
         */
        function onPopupMouseUp(event) {
            isPopupDragging = false;
            popupContent.classList.remove('dragging');
        }
        
        /**
         * MODIFIED: Handles mouse move for both panning and video scrubbing within the current state's time range.
         */
        function onPopupMouseMove(event) {
            if (!isPopupDragging || !isVideoReadyForScrub) return;

            if (zoomLevel > 1) {
                const deltaX = event.clientX - startPopupDragX;
                const deltaY = event.clientY - startPopupDragY;
                panX = startPanX + deltaX;
                panY = startPanY + deltaY;
                drawVideoFrame();
            } else {
                if (!popupVideo.duration || popupVideo.seeking) return;

                const stateConfig = hotspotConfigurations.states[currentVideoState];
                const scrubStart = stateConfig.scrubRange[0];
                const scrubEnd = stateConfig.scrubRange[1];
                const scrubDuration = scrubEnd - scrubStart;

                const sensitivity = (scrubDuration / popupCanvas.clientWidth) * 2;
                const deltaX = event.clientX - startPopupDragX;
                let newTime = startVideoTimeOnDrag + deltaX * sensitivity;

                if (newTime < scrubStart) {
                    newTime = scrubEnd - (scrubStart - newTime) % scrubDuration;
                } else if (newTime > scrubEnd) {
                    newTime = scrubStart + (newTime - scrubStart) % scrubDuration;
                }

                if (Math.abs(newTime - popupVideo.currentTime) > 0.01) {
                    popupVideo.currentTime = newTime;
                    updateHotspotsForVideo(newTime);
                }
            }
        }
        
        /**
         * Handles the touch start event for the popup video.
         */
        function onPopupTouchStart(event) {
            if (!isVideoReadyForScrub || event.touches.length !== 1 || event.target.closest('.hotspot-2d')) return;

            isPopupDragging = true;
            startPopupDragX = event.touches[0].clientX;
            startPopupDragY = event.touches[0].clientY;
            
            if (zoomLevel > 1) {
                startPanX = panX;
                startPanY = panY;
            } else {
                startVideoTimeOnDrag = popupVideo.currentTime;
            }
        }
        
        /**
         * Handles the touch end event for the popup video.
         */
        function onPopupTouchEnd(event) {
            isPopupDragging = false;
        }

        /**
         * MODIFIED: Handles touch move for both panning and video scrubbing within the current state's time range.
         */
        function onPopupTouchMove(event) {
            if (!isPopupDragging || !isVideoReadyForScrub || event.touches.length !== 1) return;
            event.preventDefault();

            if (zoomLevel > 1) {
                const deltaX = event.touches[0].clientX - startPopupDragX;
                const deltaY = event.touches[0].clientY - startPopupDragY;
                panX = startPanX + deltaX;
                panY = startPanY + deltaY;
                drawVideoFrame();
            } else {
                 if (!popupVideo.duration || popupVideo.seeking) return;

                const stateConfig = hotspotConfigurations.states[currentVideoState];
                const scrubStart = stateConfig.scrubRange[0];
                const scrubEnd = stateConfig.scrubRange[1];
                const scrubDuration = scrubEnd - scrubStart;

                const deltaX = event.touches[0].clientX - startPopupDragX;
                const sensitivity = (scrubDuration / popupCanvas.clientWidth) * 2;
                let newTime = startVideoTimeOnDrag + deltaX * sensitivity;
                
                if (newTime < scrubStart) {
                    newTime = scrubEnd - (scrubStart - newTime) % scrubDuration;
                } else if (newTime > scrubEnd) {
                    newTime = scrubStart + (newTime - scrubStart) % scrubDuration;
                }

                if (Math.abs(newTime - popupVideo.currentTime) > 0.01) {
                    popupVideo.currentTime = newTime;
                    updateHotspotsForVideo(newTime);
                }
            }
        }

        /**
         * Initializes the 360-degree image viewer.
         */
        function init() {
            // NEW: Initialize canvas elements
            popupCanvas = document.getElementById('popupCanvas');
            ctx = popupCanvas.getContext('2d');
            
            // Set video sources from cache
            popupVideo.src = assetCache['https://mahindra.inceptionx.io/res/3D/tractor_animation.webm'];
            document.querySelector('#static360Icon video').src = assetCache['https://mahindra.inceptionx.io/res/ui/360.webm'];

            // Create a video element for the hotspot texture
            const hotspotVideoElement = document.createElement('video');
            hotspotVideoElement.src = assetCache['https://mahindra.inceptionx.io/res/ui/explore_tractor.webm'];
            hotspotVideoElement.crossOrigin = "anonymous";
            hotspotVideoElement.loop = true;
            hotspotVideoElement.muted = !isSoundOn;
            hotspotVideoElement.playsInline = true;
            hotspotVideoElement.play();
            hotspotVideoTexture = new THREE.VideoTexture(hotspotVideoElement);
            
            // Create audio element for bonnet sound
            bonnetSound = new Audio(assetCache['https://mahindra.inceptionx.io/res/ui/bonnet_clip.mp3']);
            bonnetSound.loop = true;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 0);
            camera.rotation.y = -Math.PI / 2;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            renderer.domElement.style.display = 'block';

            const geometry = new THREE.SphereGeometry(100, 60, 40);
            material = new THREE.MeshBasicMaterial({ side: THREE.BackSide });
            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            loadPanoramicImage(panoData[0].imageUrl, 0);

            // Event Listeners
            renderer.domElement.addEventListener('mousedown', onMouseDown);
            renderer.domElement.addEventListener('mouseup', onMouseUp);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            renderer.domElement.addEventListener('click', onCanvasClick);
            renderer.domElement.addEventListener('wheel', onMouseWheel);
            renderer.domElement.addEventListener('touchstart', onTouchStart);
            renderer.domElement.addEventListener('touchend', onTouchEnd);
            renderer.domElement.addEventListener('touchmove', onTouchMove);

            window.addEventListener('resize', onWindowResize, false);
            closeVideoBtn.addEventListener('click', hideVideo);
            closePopupBtn.addEventListener('click', hideOptionsPopup);
            
            // MODIFIED: Add a persistent listener to draw frames whenever a seek is completed.
            popupVideo.addEventListener('seeked', drawVideoFrame);
            
            popupContent.addEventListener('mousedown', onPopupMouseDown);
            popupContent.addEventListener('mouseup', onPopupMouseUp);
            popupContent.addEventListener('mousemove', onPopupMouseMove);
            popupContent.addEventListener('mouseleave', onPopupMouseUp);
            popupContent.addEventListener('touchstart', onPopupTouchStart);
            popupContent.addEventListener('touchend', onPopupTouchEnd);
            popupContent.addEventListener('touchmove', onPopupTouchMove);

            closeInstructionBtn.addEventListener('click', hideInstructionPopup);
            
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            zoomIn360Btn.addEventListener('click', zoomIn360);
            zoomOut360Btn.addEventListener('click', zoomOut360);
            soundBtn.addEventListener('click', toggleSound);

            document.querySelectorAll('#static360Icon video').forEach(video => {
                video.addEventListener('ended', function() { this.play().catch(e => {}); });
            });
            updateSoundButton();
        }

        /**
         * MODIFIED: Adjusts the camera aspect ratio and renderer size on window resize,
         * and resizes the popup content if it's visible.
         */
        function onWindowResize() {
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
            }
            if (renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
            sizePopupContent();
        }

        /**
         * MODIFIED: Sizes the popup content to 'cover' the viewport, eliminating black bars.
         */
        function sizePopupContent() {
            if (optionsPopup.style.display !== 'flex' || !popupVideo.videoWidth || !popupVideo.videoHeight) {
                return;
            }

            const canvasWrapper = document.getElementById('canvasWrapper');
            const containerW = window.innerWidth;
            const containerH = window.innerHeight;
            const containerRatio = containerW / containerH;

            const contentW = popupVideo.videoWidth;
            const contentH = popupVideo.videoHeight;
            const contentRatio = contentW / contentH;

            let finalW, finalH;

            if (containerRatio > contentRatio) {
                // Container is wider than the video. Cover by making video width match container width.
                finalW = containerW;
                finalH = containerW / contentRatio;
            } else {
                // Container is taller than the video. Cover by making video height match container height.
                finalH = containerH;
                finalW = containerH * contentRatio;
            }

            canvasWrapper.style.width = `${finalW}px`;
            canvasWrapper.style.height = `${finalH}px`;
        }

        /**
         * Loads a new panoramic image and applies it to the sphere, and updates hotspots.
         */
        function loadPanoramicImage(imageUrl, panoIndex) {
            hotspotMeshes.forEach(mesh => scene.remove(mesh));
            hotspotMeshes = [];
            
            const loader = new THREE.TextureLoader();
            const blobUrl = assetCache[imageUrl];

            const onTextureLoad = (texture) => {
                texture.wrapS = THREE.RepeatWrapping;
                texture.repeat.x = -1;
                material.map = texture;
                material.needsUpdate = true;
                const currentPano = panoData[panoIndex];
                if (currentPano && currentPano.hotspots) {
                    currentPano.hotspots.forEach(createHotspot);
                }
            };
            
            const onTextureError = (error) => {
                 console.error('An error occurred loading the texture:', error);
                 material.map = null;
                 material.color.setHex(0x1a1a1a);
                 material.needsUpdate = true;
            };

            if (blobUrl) {
                 loader.load(blobUrl, onTextureLoad, undefined, onTextureError);
            } else {
                 // Fallback to original URL if blob somehow failed
                 loader.load(imageUrl, onTextureLoad, undefined, onTextureError);
            }
        }

        /**
         * Creates a canvas element with text drawn on it.
         */
        function createTextCanvas(text, opts) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const font = `${opts.fontSize || 24}px ${opts.fontFace || 'Arial'}`;
            context.font = font;
            const metrics = context.measureText(text);
            canvas.width = metrics.width;
            canvas.height = opts.fontSize || 24;
            context.font = font;
            context.fillStyle = opts.color || 'black';
            context.fillText(text, 0, (opts.fontSize || 24) * 0.85);
            return canvas;
        }

        /**
         * Creates a 3D hotspot mesh and adds it to the scene.
         */
        function createHotspot(hotspotData) {
            let hotspotObject;
            if (hotspotData.type === "arrow") {
                const arrowVideo = document.createElement('video');
                arrowVideo.src = assetCache['https://mahindra.inceptionx.io/res/ui/nav_arrow.webm'];
                arrowVideo.crossOrigin = "anonymous";
                arrowVideo.loop = true;
                arrowVideo.muted = true;
                arrowVideo.playsInline = true;
                arrowVideo.play().catch(e => console.error("Autoplay failed for arrow video", e));
                const arrowVideoTexture = new THREE.VideoTexture(arrowVideo);
                const hotspotGeometry = new THREE.PlaneGeometry(15, 40);
                const hotspotMaterial = new THREE.MeshBasicMaterial({ map: arrowVideoTexture, transparent: true, side: THREE.DoubleSide });
                hotspotMaterial.onBeforeCompile = (shader) => {
                    shader.fragmentShader = shader.fragmentShader.replace('#include <map_fragment>', `
                        #ifdef USE_MAP
                            vec4 texelColor = texture2D( map, vUv );
                            texelColor = mapTexelToLinear( texelColor );
                            float luma = dot(texelColor.rgb, vec3(0.299, 0.587, 0.114));
                            if (luma < 0.2) discard;
                            diffuseColor *= texelColor;
                        #endif
                    `);
                };
                hotspotObject = new THREE.Mesh(hotspotGeometry, hotspotMaterial);
                if (hotspotData.rotation) {
                    hotspotObject.rotation.set(3.14/2, 0, 3.14/2);
                }
            } else {
                const spriteMaterial = new THREE.SpriteMaterial({ map: hotspotVideoTexture, transparent: true, depthWrite: false });
                spriteMaterial.onBeforeCompile = (shader) => {
                    shader.fragmentShader = shader.fragmentShader.replace('#include <map_fragment>', `
                        #ifdef USE_MAP
                            vec4 texelColor = texture2D( map, vUv );
                            texelColor = mapTexelToLinear( texelColor );
                            float luma = dot(texelColor.rgb, vec3(0.299, 0.587, 0.114));
                            if (luma < 0.2) discard;
                            diffuseColor *= texelColor;
                        #endif
                    `);
                };
                hotspotObject = new THREE.Sprite(spriteMaterial);
                hotspotObject.scale.set(5, 5, 1);
            }

            if (hotspotData.label && hotspotData.type !== 'arrow') {
                const textCanvas = createTextCanvas(hotspotData.label, { color: 'black', fontSize: 30 });
                const textTexture = new THREE.CanvasTexture(textCanvas);
                const textMaterial = new THREE.SpriteMaterial({ map: textTexture, transparent: true });
                const textSprite = new THREE.Sprite(textMaterial);
                textSprite.scale.set(textCanvas.width / 10, textCanvas.height / 10, 1);
                textSprite.position.y = -5;
                const group = new THREE.Group();
                group.add(hotspotObject);
                group.add(textSprite);
                group.position.copy(hotspotData.position);
                group.userData = hotspotData;
                scene.add(group);
                hotspotMeshes.push(group);
            } else {
                hotspotObject.position.copy(hotspotData.position);
                hotspotObject.userData = hotspotData;
                scene.add(hotspotObject);
                hotspotMeshes.push(hotspotObject);
            }
        }

        /**
         * Shows the video overlay and plays the specified video.
         */
        function showVideo(videoUrl) {
            let embedUrl = videoUrl;
            if (videoUrl.includes('youtu.be') || videoUrl.includes('youtube.com')) {
                const match = videoUrl.match(/(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})/i);
                if (match && match[1]) {
                    embedUrl = `https://www.youtube.com/embed/${match[1]}?autoplay=1&rel=0`;
                } else {
                    console.error("Invalid YouTube URL:", videoUrl);
                    return;
                }
            }
            videoPlayer.src = embedUrl;
            videoOverlay.style.display = 'flex';
            static360Icon.style.opacity = '0';
            verticalToolbar.style.display = 'none';
        }

        /**
         * Hides the video overlay.
         */
        function hideVideo() {
            videoPlayer.src = '';
            videoOverlay.style.display = 'none';
            static360Icon.style.opacity = '1';
            verticalToolbar.style.display = 'flex';
        }

        /**
         * Shows the instruction popup.
         */
        function showInstructionPopup() {
            instructionPopupOverlay.style.display = 'flex';
        }

        /**
         * Hides the instruction popup.
         */
        function hideInstructionPopup() {
            instructionPopupOverlay.style.display = 'none';
            static360Icon.style.opacity = '1';
            verticalToolbar.style.display = 'flex';
        }

        /**
         * MODIFIED: Shows the options popup and prepares the video for scrubbing.
         */
        function showOptionsPopup() {
            optionsPopup.style.display = 'flex';
            popupLoader.style.display = 'flex'; // Show the loader
            popupCanvas.style.display = 'block';
            
            initialize2DHotspots();

            currentVideoState = 'bonnetClosed';
            const initialStateConfig = hotspotConfigurations.states[currentVideoState];

            const setupVideoAndCanvas = () => {
                popupCanvas.width = popupVideo.videoWidth;
                popupCanvas.height = popupVideo.videoHeight;
                sizePopupContent(); 
                
                // This one-time listener handles the UI changes after the *first* frame is ready.
                const onFirstSeek = () => {
                    updateHotspotsForVideo(popupVideo.currentTime);
                    hotspot2DContainer.style.display = 'block';
                    isVideoReadyForScrub = true;
                    popupLoader.style.display = 'none';
                    popupVideo.removeEventListener('seeked', onFirstSeek); // Clean up this specific listener
                }
                popupVideo.addEventListener('seeked', onFirstSeek);
                
                // Set video to the start time, which will trigger the 'seeked' event for the first frame.
                popupVideo.currentTime = initialStateConfig.scrubRange[0];
                
                popupVideo.onloadedmetadata = null;
            };

            if (popupVideo.readyState >= 1) { // HAVE_METADATA
                setupVideoAndCanvas();
            } else {
                popupVideo.onloadedmetadata = setupVideoAndCanvas;
            }
            
            static360Icon.style.opacity = '1';
        }

        /**
         * Hides the options popup.
         */
        function hideOptionsPopup() {
            optionsPopup.style.display = 'none';
            popupCanvas.style.display = 'none';
            hideTextInfo();
            static360Icon.style.opacity = '1';
            verticalToolbar.style.display = 'flex';
            popupLoader.style.display = 'none'; // Ensure loader is hidden on close

            // *** FIX: Reset the ready flag when the popup is closed ***
            isVideoReadyForScrub = false;
            
            if (transitionAnimationId) {
                cancelAnimationFrame(transitionAnimationId);
                transitionAnimationId = null;
            }
            popupVideo.onended = null;
            popupVideo.onloadedmetadata = null;


            if (bonnetSound) {
                bonnetSound.pause();
                bonnetSound.currentTime = 0;
            }

            if (activeHotspotVideo) {
                activeHotspotVideo.style.display = 'none';
                activeHotspotVideo.pause();
                const siblingImg = activeHotspotVideo.parentElement.querySelector('img');
                if (siblingImg) siblingImg.style.display = 'block';
                activeHotspotVideo = null;
            }

            zoomLevel = 1;
            panX = 0;
            panY = 0;
        }
        
        /**
         * Plays a sound file if sound is enabled.
         */
        function playSound(url) {
            if (!isSoundOn || !url) return;
            const audio = new Audio(assetCache[url]);
            audio.play().catch(e => console.error("Error playing sound:", e));
        }

        /**
         * *** OPTIMIZATION: Creates all 2D hotspot elements once. ***
         */
        function initialize2DHotspots() {
            if (hotspotsInitialized) return;

            hotspot2DContainer.innerHTML = ''; // Clear just in case

            for (const stateName in hotspotConfigurations.states) {
                const stateConfig = hotspotConfigurations.states[stateName];
                stateConfig.options.forEach(option => {
                    option.hotspots.forEach(hotspotData => {
                        const hotspotElement = document.createElement('div');
                        hotspotElement.className = 'hotspot-2d';
                        hotspotElement.style.left = `${hotspotData.x}%`;
                        hotspotElement.style.top = `${hotspotData.y}%`;
                        hotspotElement.title = hotspotData.label;
                        hotspotElement.style.display = 'none'; // Initially hidden

                        // Store data for visibility checks
                        hotspotElement.dataset.state = stateName;
                        hotspotElement.dataset.rangeStart = option.range[0];
                        hotspotElement.dataset.rangeEnd = option.range[1];
                        
                        const hotspotImage = new Image();
                        hotspotImage.src = assetCache[(hotspotData.type === "transition") ? 'https://mahindra.inceptionx.io/res/ui/hotspot_bonnet.png' : 'https://mahindra.inceptionx.io/res/ui/hotspot_normal.png'];
                        hotspotImage.style.display = 'block';
                        hotspotElement.appendChild(hotspotImage);

                        const hotspotVideo = document.createElement('video');
                        const hotspotVideoSrc = (hotspotData.type === "transition") ? 'https://mahindra.inceptionx.io/res/ui/hotspot.webm' : 'https://mahindra.inceptionx.io/res/ui/hotspot_optionspopup.webm';
                        hotspotVideo.src = assetCache[hotspotVideoSrc];
                        hotspotVideo.crossOrigin = "anonymous";
                        hotspotVideo.loop = true;
                        hotspotVideo.muted = true;
                        hotspotVideo.playsInline = true;
                        hotspotVideo.style.display = 'none';
                        hotspotElement.appendChild(hotspotVideo);

                        hotspotElement.addEventListener('click', () => {
                            if (activeHotspotVideo && activeHotspotVideo !== hotspotVideo) {
                                activeHotspotVideo.style.display = 'none';
                                activeHotspotVideo.pause();
                                const siblingImg = activeHotspotVideo.parentElement.querySelector('img');
                                if (siblingImg) siblingImg.style.display = 'block';
                            }

                            hotspotImage.style.display = 'none';
                            hotspotVideo.style.display = 'block';
                            hotspotVideo.currentTime = 0;
                            hotspotVideo.play();
                            activeHotspotVideo = hotspotVideo;

                            if (hotspotData.type === "transition") {
                                handleTransition(hotspotData);
                            } else if (hotspotData.type === "text_info") {
                                showTextInfo(hotspotData.text);
                            }
                        });

                        hotspot2DContainer.appendChild(hotspotElement);
                        allHotspotElements.push(hotspotElement);
                    });
                });
            }
            hotspotsInitialized = true;
        }
        
        /**
         * NEW: Handles playing a transition animation segment within the main video.
         */
        function handleTransition(hotspotData) {
            hotspot2DContainer.style.display = 'none'; // Hide hotspots during transition
            if (hotspotData.soundUrl) playSound(hotspotData.soundUrl);

            popupVideo.loop = false;
            popupVideo.muted = !isSoundOn;
            popupVideo.currentTime = hotspotData.transitionRange[0]; // Go to start of animation
            popupVideo.play();
            
            const animateTransition = () => {
                drawVideoFrame();
                // Check if the transition animation is complete
                if (popupVideo.currentTime >= hotspotData.transitionRange[1] - 0.1) { // Use a small buffer
                    if (transitionAnimationId) {
                        cancelAnimationFrame(transitionAnimationId);
                        transitionAnimationId = null;
                    }
                    popupVideo.pause();

                    // Switch to the next state
                    currentVideoState = hotspotData.nextState;
                    const newStateConfig = hotspotConfigurations.states[currentVideoState];
                    
                    // <<< MODIFIED: Check for a specific start time, otherwise default to the start of the scrub range.
                    const startTime = hotspotData.nextStateStartTime !== undefined
                        ? hotspotData.nextStateStartTime
                        : newStateConfig.scrubRange[0];
                    
                    // Set video to the specified start time
                    popupVideo.currentTime = startTime;
                    
                    // Update hotspots for the new state
                    updateHotspotsForVideo(popupVideo.currentTime);

                    // Re-enable UI
                    hotspot2DContainer.style.display = 'block';
                } else {
                    transitionAnimationId = requestAnimationFrame(animateTransition);
                }
            };
            animateTransition();
        }


        /**
         * *** OPTIMIZATION: Updates hotspot visibility instead of recreating them. ***
         */
        function updateHotspotsForVideo(videoTime) {
            allHotspotElements.forEach(element => {
                const state = element.dataset.state;
                const rangeStart = parseFloat(element.dataset.rangeStart);
                const rangeEnd = parseFloat(element.dataset.rangeEnd);

                if (state === currentVideoState && videoTime >= rangeStart && videoTime <= rangeEnd) {
                    element.style.display = 'block';
                } else {
                    element.style.display = 'none';
                }
            });
        }


        /**
         * Shows the text info box with a given text.
         */
        function showTextInfo(text) {
            if (textInfoTimer) clearTimeout(textInfoTimer);
            textInfoContent.textContent = text;
            textInfoBox.style.display = 'flex';
            textInfoTimer = setTimeout(hideTextInfo, 5000);
        }

        /**
         * Hides the text info box.
         */
        function hideTextInfo() {
            textInfoBox.style.display = 'none';
        }
        
        /**
         * NEW: Draws the current video frame to the canvas, applying zoom and pan.
         */
        function drawVideoFrame() {
            if (!popupCanvas.width || !popupCanvas.height || !popupVideo.videoWidth || !popupVideo.videoHeight) {
                return;
            }
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, popupCanvas.width, popupCanvas.height);

            const sWidth = popupVideo.videoWidth / zoomLevel;
            const sHeight = popupVideo.videoHeight / zoomLevel;
            let sx = (popupVideo.videoWidth - sWidth) / 2 - panX;
            let sy = (popupVideo.videoHeight - sHeight) / 2 - panY;

            sx = Math.max(0, Math.min(sx, popupVideo.videoWidth - sWidth));
            sy = Math.max(0, Math.min(sy, popupVideo.videoHeight - sHeight));
            panX = (popupVideo.videoWidth - sWidth) / 2 - sx;
            panY = (popupVideo.videoHeight - sHeight) / 2 - sy;


            ctx.drawImage(
                popupVideo,
                sx, sy, sWidth, sHeight,
                0, 0, popupCanvas.width, popupCanvas.height
            );
        }


        /**
         * The main animation loop.
         */
        function animate() {
            requestAnimationFrame(animate);
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        /**
         * Function to be called when the start button is clicked.
         */
        function startExperience() {
            landingPage.classList.add('hidden');
            // Wait for the fade-out transition to finish before initializing
            setTimeout(() => {
                landingPage.style.display = 'none';
                init();
                animate();
                showInstructionPopup();
            }, 1000);
        }
        
        /**
         * NEW: Toggles fullscreen mode for the entire page.
         */
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.warn(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        /**
         * Zooms into the 360-degree scene or the options popup.
         */
        function zoomIn360() {
            if (optionsPopup.style.display === 'flex') {
                if (zoomLevel < maxZoom) {
                    zoomLevel = Math.min(maxZoom, zoomLevel + 0.5);
                    drawVideoFrame();
                }
                if (zoomLevel > 1) {
                    hotspot2DContainer.style.display = 'none';
                }
            } else {
                camera.fov = Math.max(10, camera.fov - 5);
                camera.updateProjectionMatrix();
            }
        }

        /**
         * Zooms out of the 360-degree scene or the options popup.
         */
        function zoomOut360() {
            if (optionsPopup.style.display === 'flex') {
                if (zoomLevel > minZoom) {
                    zoomLevel = Math.max(minZoom, zoomLevel - 0.5);
                    if (zoomLevel === 1) {
                        panX = 0;
                        panY = 0;
                        hotspot2DContainer.style.display = 'block';
                    }
                    drawVideoFrame();
                }
            } else {
                camera.fov = Math.min(60, camera.fov + 5);
                camera.updateProjectionMatrix();
            }
        }

        /**
         * Toggles sound for all video elements.
         */
        function toggleSound() {
            isSoundOn = !isSoundOn;
            document.querySelectorAll('video').forEach(video => {
                video.muted = !isSoundOn;
            });
            if (bonnetSound) bonnetSound.muted = !isSoundOn;
            updateSoundButton();
        }
        
        /**
         * MODIFIED: Updates the sound button's background image based on the sound state, using cached assets.
         */
        function updateSoundButton() {
            const onImgUrl = assetCache['https://mahindra.inceptionx.io/res/ui/vol_on.png'];
            const offImgUrl = assetCache['https://mahindra.inceptionx.io/res/ui/vol_off.png'];
            soundBtn.style.backgroundImage = isSoundOn ? `url(${onImgUrl})` : `url(${offImgUrl})`;
        }
        
        // Hide landing page initially to show loader first
        landingPage.style.display = 'none';

        // Start preloading assets as soon as the script runs
        preloadAssets();

        // Add the event listener to the start button
        startButton.addEventListener('click', startExperience);
    </script>
</body>
</html>
